<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å–®å­—å¡</title>
  <style>
    :root{
      --purple:#9d8fc4;     /* èŠ‹é ­ç´« */
      --cream:#fff8ee;      /* å¥¶æ²¹ç™½ */
      --line:#e6ddcf;
      --text:#3a3a3a;
      --muted:#8e8a84;
      --card:#ffffff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      background: var(--cream);
      color: var(--text);
      min-height:100vh;
      padding: 18px;
      display:flex;
      justify-content:center;
    }
    .app{ width: 380px; max-width: 94vw; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 12px;
    }
    .brand{
      font-weight: 1000; letter-spacing:.2px; color:#5a4b86; user-select:none;
      display:flex; align-items:center; gap:8px;
    }
    .chip{
      border: 1px solid var(--line);
      background: rgba(155,138,203,.10);
      color: #605484;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
    }
    .iconbtn{
      width: 44px; height: 38px;
      border-radius: 12px;
      border: 1.5px solid var(--line);
      background: rgba(255,255,255,.7);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
    }
    .burger{ width:18px; height:12px; position:relative; }
    .burger span{
      position:absolute; left:0; right:0;
      height:2px; border-radius:999px;
      background: #62548c;
    }
    .burger span:nth-child(1){ top:0; }
    .burger span:nth-child(2){ top:5px; opacity:.9; }
    .burger span:nth-child(3){ top:10px; }

    .shell{
      background: var(--card);
      border-radius: 20px;
      border: 2px solid var(--line);
      padding: 18px 16px;
      box-shadow:0 12px 30px rgba(0,0,0,.08);
      overflow:hidden;
    }

    .view{ display:none; }
    .view.active{ display:block; }

    /* Study */
    .study-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 10px; color: var(--muted); font-size: 12px;
      font-weight: 800;
    }
    .word{
      font-size: 34px;
      font-weight: 1000;
      letter-spacing: .2px;
      text-align:center;
      margin: 12px 0 10px;
      user-select:none;
    }
    .back{
      display:none;
      font-size: 18px;
      line-height: 1.65;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px dashed var(--line);
      background: rgba(255,248,238,.65);
      margin: 0 auto;
      white-space: pre-line;
    }
    .tapArea{ padding: 6px 4px 0; cursor:pointer; }
    .buttons{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    button{
      border-radius:999px;
      border:2px solid var(--purple);
      background:white;
      color: var(--purple);
      padding: 10px;
      font-size: 14px;
      font-weight: 1000;
      cursor:pointer;
    }
    button.primary{ background: var(--purple); color:white; }
    .toast{
      margin-top: 12px;
      min-height: 18px;
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      font-weight: 800;
    }

    /* Forms / Sections */
    .title{ font-weight: 1000; color:#5a4b86; margin: 4px 0 10px; }
    .subtitle{ color: var(--muted); font-size: 13px; margin: 0 0 14px; line-height: 1.6; font-weight: 700; }
    .field{ margin-bottom: 10px; }
    .field label{
      display:block; font-size: 12px; color: var(--muted);
      margin: 0 0 6px; font-weight: 900;
    }
    .field input, .field textarea{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1.5px solid var(--line);
      outline:none;
      font-size: 14px;
      background: rgba(255,255,255,.9);
    }
    .field textarea{ min-height: 110px; resize: vertical; }
    .row{ display:flex; gap:10px; margin-top: 10px; }
    .row button{
      flex:1;
      border-width: 1.5px;
      padding: 10px 12px;
      font-size: 14px;
    }
    .row button.secondary{
      background: transparent;
      border-color: var(--line);
      color:#5a4b86;
    }
    .box{
      border: 1.5px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,248,238,.55);
      margin-top: 10px;
    }
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 360px){
      .kpi{ grid-template-columns: 1fr; }
    }
    .kpi .tile{
      border: 1.5px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: rgba(155,138,203,.06);
    }
    .kpi .label{ font-size:12px; color: var(--muted); font-weight: 900; }
    .kpi .val{ font-size:26px; font-weight: 1100; color:#5a4b86; margin-top: 4px; }

    /* Drawer */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.25);
      display:none;
      z-index: 50;
    }
    .overlay.open{ display:block; }
    .drawer{
      position: fixed;
      top: 0; right: 0;
      height: 100vh;
      width: 290px;
      max-width: 82vw;
      background: rgba(255,255,255,.96);
      border-left: 2px solid var(--line);
      box-shadow: -10px 0 30px rgba(0,0,0,.12);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index: 60;
      padding: 16px;
      backdrop-filter: blur(10px);
      overflow:auto;
    }
    .drawer.open{ transform: translateX(0); }
    .dtitle{ font-weight: 1100; color:#5a4b86; margin: 4px 0 14px; }
    .menu{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .menu button{
      width:100%;
      text-align:left;
      border: 1.5px solid var(--line);
      background: white;
      color:#5a4b86;
      padding: 12px 12px;
      border-radius: 14px;
      font-weight: 1000;
      cursor:pointer;
    }
    .menu button.active{
      border-color: var(--purple);
      background: rgba(155,138,203,.10);
    }
    .smallnote{
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
      font-weight: 700;
    }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">å–®å­—å¡</div>
      <div class="chip" id="statsChip">ä»Šæ—¥ 0ï½œå¾…è¤‡ç¿’ 0ï½œç¸½æ•¸ 0</div>
      <button class="iconbtn" id="menuBtn" aria-label="menu">
        <div class="burger" aria-hidden="true">
          <span></span><span></span><span></span>
        </div>
      </button>
    </div>

    <div class="shell">
      <!-- 1) èƒŒå–®å­— -->
      <div class="view active" id="view-study">
        <div class="study-top">
          <span id="hint">é»ä¸€ä¸‹ç¿»å¡</span>
          <span>åˆ°æœŸå„ªå…ˆ</span>
        </div>

        <div class="tapArea" id="tapArea">
          <div class="word" id="word">ï¼ˆå°šç„¡å–®å­—ï¼‰</div>
          <div class="back" id="back"></div>
        </div>

        <div class="buttons">
          <button id="btnShort">5ï½10 å¼µå¾Œ</button>
          <button id="btnHalf">åŠå¤©å¾Œ</button>
          <button id="btnDay">ä¸€å¤©å¾Œ</button>
          <button class="primary" id="btnFive">äº”å¤©å¾Œ</button>
        </div>

        <div class="toast" id="toastStudy"></div>
      </div>

      <!-- 2) æ–°å¢å–®å­— -->
      <div class="view" id="view-add">
        <div class="title">â• æ–°å¢å–®å­—</div>
        <div class="subtitle">è‹±ï¼‹ä¸­å¿…å¡«ã€‚è©æ€§å¯ç”¨ n./v./adj.ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å¯«ã€‚</div>

        <div class="field">
          <label>è‹±æ–‡ï¼ˆå¿…å¡«ï¼‰</label>
          <input id="new-en" placeholder="ä¾‹å¦‚: endeavor" />
        </div>
        <div class="field">
          <label>è©æ€§ï¼ˆå¯ç•™ç©ºï¼‰</label>
          <input id="new-pos" placeholder="ä¾‹å¦‚: v. / n. / adj." />
        </div>
        <div class="field">
          <label>ä¸­æ–‡ï¼ˆå¿…å¡«ï¼‰</label>
          <input id="new-zh" placeholder="ä¾‹å¦‚: åŠªåŠ›å˜—è©¦" />
        </div>

        <div class="row">
          <button class="primary" id="btnAdd">åŠ å…¥å–®å­—</button>
          <button class="secondary" id="btnGoStudy1">å›å»èƒŒ</button>
        </div>
        <div class="toast" id="toastAdd"></div>
      </div>

      <!-- 3) åŒæ­¥/å‚™ä»½ -->
      <div class="view" id="view-sync">
        <div class="title">ğŸ”„ åŒæ­¥ / å‚™ä»½</div>
        <div class="subtitle">
          ä¸åŒçš„äººç”¨è‡ªå·±çš„å‚™ä»½ç¢¼å°±å¥½ï¼š<br/>
          ä½ æŠŠä½ çš„å‚™ä»½ç¢¼å­˜èµ·ä¾†ï¼Œåˆ¥äººä¹Ÿå­˜è‡ªå·±çš„ã€‚<br/>
          æ›äººç”¨ï¼šå…ˆæ¸…ç©º â†’ è²¼ä»–çš„å‚™ä»½ç¢¼ â†’ å°±æ˜¯ä»–çš„è³‡æ–™ã€‚
        </div>

        <div class="row">
          <button class="primary" id="btnExport">ä¸€éµè¤‡è£½å‚™ä»½ç¢¼</button>
          <button class="secondary" id="btnImport">è²¼ä¸ŠåŒæ­¥</button>
        </div>

        <div class="box">
          <div style="font-weight:1000;color:#5a4b86;">æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™ï¼ˆå¾ˆå±éšªï¼‰</div>
          <div style="font-size:12px;color:var(--muted);line-height:1.6;font-weight:700;margin-top:6px;">
            æœƒæ¸…ç©ºé€™å°è£ç½®ä¸Šçš„å–®å­—åº«ï¼‹é€²åº¦ï¼‹çµ±è¨ˆã€‚<br/>
            å»ºè­°å…ˆå‚™ä»½å†æ¸…ç©ºã€‚
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="secondary" id="btnWipeAll">æˆ‘ç¢ºå®šè¦æ¸…ç©º</button>
            <button class="secondary" id="btnGoStudy2">å›å»èƒŒ</button>
          </div>
        </div>

        <div class="toast" id="toastSync"></div>
      </div>

      <!-- 4) çµ±è¨ˆ -->
      <div class="view" id="view-stats">
        <div class="title">ğŸ“Š çµ±è¨ˆ</div>
        <div class="subtitle">ä¸æƒ…å‹’ç‰ˆæœ¬ï¼šåªçµ¦ä½ æœ€æœ‰ç”¨çš„é€²åº¦æ„Ÿã€‚</div>

        <div class="kpi">
          <div class="tile">
            <div class="label">ä»Šæ—¥å®Œæˆ</div>
            <div class="val" id="kpiDone">0</div>
          </div>
          <div class="tile">
            <div class="label">å¾…è¤‡ç¿’</div>
            <div class="val" id="kpiDue">0</div>
          </div>
          <div class="tile">
            <div class="label">å–®å­—ç¸½æ•¸</div>
            <div class="val" id="kpiTotal">0</div>
          </div>
        </div>

        <div class="box">
          <div style="font-weight:1000;color:#5a4b86;">æœ€è¿‘ 7 å¤©ï¼ˆå®Œæˆå¼µæ•¸ï¼‰</div>
          <div style="font-size:12px;color:var(--muted);line-height:1.7;font-weight:700;margin-top:6px;" id="weekList">
            ï¼ˆå°šç„¡ç´€éŒ„ï¼‰
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="secondary" id="btnResetToday">æŠŠä»Šæ—¥å®Œæˆæ­¸é›¶</button>
          <button class="secondary" id="btnGoStudy3">å›å»èƒŒ</button>
        </div>
        <div class="toast" id="toastStats"></div>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div class="overlay" id="overlay"></div>
  <div class="drawer" id="drawer">
    <div class="dtitle">é¸å–®</div>
    <div class="menu">
      <button data-view="study" id="mStudy" class="active">ğŸƒ èƒŒå–®å­—</button>
      <button data-view="add" id="mAdd">â• æ–°å¢å–®å­—</button>
      <button data-view="sync" id="mSync">ğŸ”„ åŒæ­¥/å‚™ä»½</button>
      <button data-view="stats" id="mStats">ğŸ“Š çµ±è¨ˆ</button>
    </div>

    <div class="smallnote">
      ğŸ”¸ ä¸åŒäººå…±ç”¨ï¼šç”¨ã€Œæ¸…ç©º â†’ è²¼ä¸Šä»–çš„å‚™ä»½ç¢¼ã€åˆ‡æ›ã€‚<br/>
      ğŸ”¸ å…ˆå‚™ä»½å†æ¸…ç©ºï¼Œé¿å…ä¸€éµè’¸ç™¼ã€‚
    </div>
  </div>

<script>
/* =========================
   Storage Keys (single user)
========================= */
const STORE_KEY = "vocab_cards_single_v1";
const STATS_KEY = "vocab_stats_single_v1";

/* =========================
   Utils
========================= */
const now = () => Date.now();
const rid = () => Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
const pad2 = n => String(n).padStart(2,"0");
const todayStr = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};
function daysAgoStr(k){
  const d = new Date();
  d.setDate(d.getDate() - k);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function toast(id, msg){
  const el = document.getElementById(id);
  el.textContent = msg;
  setTimeout(()=>{ if(el.textContent === msg) el.textContent=""; }, 1600);
}

/* =========================
   Data Model
   card: { id,en,pos,zh,nextDue,shortAfterN,updatedAt }
   stats: { date, doneToday, doneByDate }
========================= */
let cards = [];
let stats = { date: todayStr(), doneToday: 0, doneByDate: {} };
let sessionSeen = 0;
let current = null;

// âœ… å®Œå…¨ç©ºç™½åº«ï¼ˆä¸å¡ç¯„ä¾‹ï¼‰
const seed = [];

/* =========================
   Load / Save
========================= */
function saveCards(){ localStorage.setItem(STORE_KEY, JSON.stringify(cards)); }
function saveStats(){ localStorage.setItem(STATS_KEY, JSON.stringify(stats)); }

function loadAll(){
  // cards
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(raw){
      cards = JSON.parse(raw);
    }else{
      cards = seed.map(x => ({
        id: rid(), en:x.en, pos:x.pos, zh:x.zh,
        nextDue: 0, shortAfterN: null, updatedAt: now()
      }));
    }
  }catch(e){
    cards = seed.map(x => ({
      id: rid(), en:x.en, pos:x.pos, zh:x.zh,
      nextDue: 0, shortAfterN: null, updatedAt: now()
    }));
  }

  // stats
  try{
    const s = localStorage.getItem(STATS_KEY);
    if(s) stats = JSON.parse(s);
  }catch(e){}

  // daily rollover
  if(stats.date !== todayStr()){
    if(stats.date){
      stats.doneByDate = stats.doneByDate || {};
      stats.doneByDate[stats.date] = stats.doneToday || 0;
    }
    stats.date = todayStr();
    stats.doneToday = 0;
    saveStats();
  }
}

/* =========================
   UI References
========================= */
const wordEl = document.getElementById("word");
const backEl = document.getElementById("back");
const hintEl = document.getElementById("hint");
const statsChipEl = document.getElementById("statsChip");
const tapArea = document.getElementById("tapArea");

const kpiDone = document.getElementById("kpiDone");
const kpiDue = document.getElementById("kpiDue");
const kpiTotal = document.getElementById("kpiTotal");
const weekList = document.getElementById("weekList");

/* =========================
   Drawer / Navigation
========================= */
const overlay = document.getElementById("overlay");
const drawer = document.getElementById("drawer");
const menuBtn = document.getElementById("menuBtn");

const viewStudy = document.getElementById("view-study");
const viewAdd = document.getElementById("view-add");
const viewSync = document.getElementById("view-sync");
const viewStats = document.getElementById("view-stats");

const menuButtons = [
  document.getElementById("mStudy"),
  document.getElementById("mAdd"),
  document.getElementById("mSync"),
  document.getElementById("mStats"),
];

function openDrawer(){ overlay.classList.add("open"); drawer.classList.add("open"); }
function closeDrawer(){ overlay.classList.remove("open"); drawer.classList.remove("open"); }
menuBtn.addEventListener("click", openDrawer);
overlay.addEventListener("click", closeDrawer);

function showView(name){
  [viewStudy, viewAdd, viewSync, viewStats].forEach(v=>v.classList.remove("active"));
  const map = { study:viewStudy, add:viewAdd, sync:viewSync, stats:viewStats };
  (map[name] || viewStudy).classList.add("active");

  menuButtons.forEach(b=>b.classList.remove("active"));
  const activeMap = { study:"mStudy", add:"mAdd", sync:"mSync", stats:"mStats" };
  document.getElementById(activeMap[name] || "mStudy").classList.add("active");

  closeDrawer();
  renderAll();
}

menuButtons.forEach(btn=>{
  btn.addEventListener("click", ()=> showView(btn.dataset.view));
});

// quick return buttons
document.getElementById("btnGoStudy1").addEventListener("click", ()=> showView("study"));
document.getElementById("btnGoStudy2").addEventListener("click", ()=> showView("study"));
document.getElementById("btnGoStudy3").addEventListener("click", ()=> showView("study"));

/* =========================
   Study behaviors
========================= */
function isDue(c){
  const dueByTime = (c.nextDue || 0) <= now();
  const dueByShort = (c.shortAfterN == null) ? true : (sessionSeen >= c.shortAfterN);
  return dueByTime && dueByShort;
}
function dueCount(){ return cards.filter(isDue).length; }
function pickNext(){
  if(!cards.length) return null;

  const due = cards.filter(isDue);
  if(due.length){
    due.sort((a,b)=> (a.updatedAt||0) - (b.updatedAt||0));
    return due[0];
  }
  const sorted = [...cards].sort((a,b)=> (a.nextDue||0) - (b.nextDue||0));
  return sorted[0];
}
function showCard(c){
  current = c;
  backEl.style.display = "none";
  hintEl.textContent = "é»ä¸€ä¸‹ç¿»å¡";
  wordEl.textContent = c.en || "ï¼ˆç„¡ï¼‰";
  backEl.innerHTML = `<div><b>${c.pos || ""}</b> ${c.zh || ""}</div>`;
}
function nextCard(){
  sessionSeen++;
  const c = pickNext();
  if(!c){
    current = null;
    wordEl.textContent = "ï¼ˆå°šç„¡å–®å­—ï¼‰";
    backEl.style.display = "none";
    hintEl.textContent = "å…ˆå»æ–°å¢å–®å­—å§";
    return;
  }
  showCard(c);
}
tapArea.addEventListener("click", ()=>{
  if(!current) return;
  backEl.style.display = "block";
  hintEl.textContent = "é¸ä¸€å€‹ä½ ç¾åœ¨çš„æ„Ÿè¦º";
});

// prevent button click from flipping
document.querySelectorAll("button").forEach(btn=>{
  btn.addEventListener("click", (e)=> e.stopPropagation());
});

function markDone(){
  stats.doneToday = (stats.doneToday || 0) + 1;
  stats.doneByDate = stats.doneByDate || {};
  stats.doneByDate[stats.date] = stats.doneToday;
  saveStats();
}

function rate(type){
  if(!current) return;

  markDone();

  const t = now();
  if(type === "short"){
    const offset = Math.floor(Math.random() * 6) + 5; // 5~10
    current.shortAfterN = sessionSeen + offset;
    current.nextDue = Math.min(current.nextDue || 0, t);
  }else if(type === "half"){
    current.nextDue = t + 12*60*60*1000;
    current.shortAfterN = null;
  }else if(type === "day"){
    current.nextDue = t + 24*60*60*1000;
    current.shortAfterN = null;
  }else if(type === "five"){
    current.nextDue = t + 5*24*60*60*1000;
    current.shortAfterN = null;
  }
  current.updatedAt = t;
  saveCards();

  nextCard();
  renderAll();
}

document.getElementById("btnShort").addEventListener("click", ()=> rate("short"));
document.getElementById("btnHalf").addEventListener("click", ()=> rate("half"));
document.getElementById("btnDay").addEventListener("click", ()=> rate("day"));
document.getElementById("btnFive").addEventListener("click", ()=> rate("five"));

/* =========================
   Add word
========================= */
function addWord(){
  const en = document.getElementById("new-en").value.trim();
  const pos = document.getElementById("new-pos").value.trim() || "";
  const zh = document.getElementById("new-zh").value.trim();

  if(!en || !zh){
    toast("toastAdd", "è‹±æ–‡å’Œä¸­æ–‡ä¸€å®šè¦å¡«å–”");
    return;
  }
  const dup = cards.find(c => (c.en||"").toLowerCase() === en.toLowerCase());
  if(dup){
    const ok = confirm(`ã€Œ${en}ã€çœ‹èµ·ä¾†å·²ç¶“å­˜åœ¨ï¼Œè¦ä»ç„¶æ–°å¢ä¸€å¼µå—ï¼Ÿ\nï¼ˆå–æ¶ˆå°±ä¸æ–°å¢ï¼‰`);
    if(!ok) return;
  }

  cards.push({
    id: rid(), en, pos, zh,
    nextDue: 0, shortAfterN: null, updatedAt: now()
  });
  saveCards();

  document.getElementById("new-en").value = "";
  document.getElementById("new-pos").value = "";
  document.getElementById("new-zh").value = "";

  toast("toastAdd", "å·²åŠ å…¥ âœ¨");
  renderAll();
}
document.getElementById("btnAdd").addEventListener("click", addWord);

/* =========================
   Sync / Backup
========================= */
function exportBackup(){
  const payload = { v: 1, cards, stats };
  const text = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
  const ok = navigator.clipboard && navigator.clipboard.writeText;
  if(ok){
    navigator.clipboard.writeText(text).then(()=>{
      toast("toastSync", "å‚™ä»½ç¢¼å·²è¤‡è£½ âœ…");
    }).catch(()=>{
      prompt("è¤‡è£½é€™æ®µå‚™ä»½ç¢¼ï¼š", text);
    });
  }else{
    prompt("è¤‡è£½é€™æ®µå‚™ä»½ç¢¼ï¼š", text);
  }
}

function importBackup(){
  const text = prompt("æŠŠå‚™ä»½ç¢¼è²¼åœ¨é€™è£¡ï¼š");
  if(!text) return;

  let payload;
  try{
    payload = JSON.parse(decodeURIComponent(escape(atob(text.trim()))));
  }catch(e){
    alert("é€™æ®µå‚™ä»½ç¢¼çœ‹èµ·ä¾†ä¸å°ğŸ¥²");
    return;
  }
  if(!payload || !payload.cards){
    alert("å‚™ä»½ç¢¼å…§å®¹ä¸å®Œæ•´ğŸ¥²");
    return;
  }

  // merge cards by id, keep newer updatedAt
  const map = new Map(cards.map(c=>[c.id,c]));
  for(const c of payload.cards){
    const old = map.get(c.id);
    if(!old) map.set(c.id, c);
    else{
      const newer = (c.updatedAt||0) >= (old.updatedAt||0) ? c : old;
      map.set(c.id, newer);
    }
  }
  cards = Array.from(map.values());
  saveCards();

  // merge stats by day max
  if(payload.stats){
    const ps = payload.stats;
    stats.doneByDate = stats.doneByDate || {};
    const other = ps.doneByDate || {};
    for(const [d,val] of Object.entries(other)){
      stats.doneByDate[d] = Math.max(stats.doneByDate[d]||0, val||0);
    }
    // align today
    if(stats.date === todayStr()){
      const incomingToday = (ps.date===stats.date) ? (ps.doneToday||0) : 0;
      stats.doneToday = Math.max(stats.doneToday||0, incomingToday, stats.doneByDate[stats.date]||0);
      stats.doneByDate[stats.date] = stats.doneToday;
    }
    saveStats();
  }

  toast("toastSync", "åŒæ­¥å®Œæˆ âœ…");
  current = null;
  nextCard();
  renderAll();
}

document.getElementById("btnExport").addEventListener("click", exportBackup);
document.getElementById("btnImport").addEventListener("click", importBackup);

/* æ¸…ç©ºå…¨éƒ¨è³‡æ–™ï¼ˆé›™ç¢ºèªï¼‰ */
document.getElementById("btnWipeAll").addEventListener("click", ()=>{
  const ok1 = confirm("ç¢ºå®šè¦æ¸…ç©ºæœ¬æ©Ÿæ‰€æœ‰è³‡æ–™å—ï¼Ÿ\nï¼ˆå–®å­—åº«ï¼‹é€²åº¦ï¼‹çµ±è¨ˆéƒ½æœƒæ¶ˆå¤±ï¼‰");
  if(!ok1) return;
  const ok2 = confirm("æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦æ¸…ç©ºå—ï¼Ÿï¼ˆé€™æ­¥ç„¡æ³•å¾©åŸï¼‰");
  if(!ok2) return;

  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(STATS_KEY);

  // reload blank
  loadAll();
  sessionSeen = 0;
  current = null;
  toast("toastSync", "å·²æ¸…ç©º âœ…");
  showView("study");
  nextCard();
  renderAll();
});

/* =========================
   Stats view
========================= */
function renderStatsView(){
  kpiDone.textContent = String(stats.doneToday || 0);
  kpiDue.textContent = String(dueCount());
  kpiTotal.textContent = String(cards.length);

  const lines = [];
  for(let i=6;i>=0;i--){
    const d = daysAgoStr(i);
    const v = (stats.doneByDate && stats.doneByDate[d]) ? stats.doneByDate[d] : 0;
    lines.push(`${d}ï¼š${v} å¼µ`);
  }
  weekList.textContent = lines.join("\n");
}

document.getElementById("btnResetToday").addEventListener("click", ()=>{
  const ok = confirm("ç¢ºå®šè¦æŠŠã€ä»Šæ—¥å®Œæˆã€æ­¸é›¶å—ï¼Ÿ\nï¼ˆåªå½±éŸ¿ä»Šå¤©çš„çµ±è¨ˆï¼‰");
  if(!ok) return;

  stats.doneToday = 0;
  stats.doneByDate = stats.doneByDate || {};
  stats.doneByDate[stats.date] = 0;
  saveStats();
  toast("toastStats", "ä»Šæ—¥å®Œæˆå·²æ­¸é›¶");
  renderAll();
});

/* =========================
   Render (global)
========================= */
function renderChip(){
  statsChipEl.textContent = `ä»Šæ—¥ ${stats.doneToday||0}ï½œå¾…è¤‡ç¿’ ${dueCount()}ï½œç¸½æ•¸ ${cards.length}`;
}
function renderAll(){
  renderChip();
  renderStatsView();
  if(document.getElementById("view-study").classList.contains("active")){
    if(!current) nextCard();
  }
}

/* =========================
   Boot
========================= */
loadAll();
nextCard();
renderAll();
</script>

</body>
</html>
